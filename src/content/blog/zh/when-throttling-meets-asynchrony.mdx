---
pubDatetime: 2020-01-16T10:14:43Z
modDatetime: 2024-02-23T09:54:13Z
title: å½“èŠ‚æµå’Œå»æŠ–é‡åˆ°å¼‚æ­¥ï¼Œå®ƒä»¬ä¼šæ“¦å‡ºæ€æ ·çš„ç«èŠ±ï¼Ÿ
featured: true
permalink: when-throttling-meets-asynchrony
originalUrl: https://github.com/bowencool/blog/issues/3
tags:
  - frontend
  - javascript
  - async
description: æœ¬æ–‡ä»‹ç»äº†ä¸€ç§å¼‚æ­¥èŠ‚æµçš„å®ç°æ–¹å¼ï¼Œä»¥åŠå®ƒçš„å­ªç”Ÿå…„å¼Ÿâ€”â€”å¼‚æ­¥é˜²æŠ–ã€‚
---

import ThrottleAsyncResultDemo from "../../_demos/ThrottleAsyncResultDemo";

> æ‰€æœ‰ä»£ç å·²ç»åŒ…å«åˆ° [async-utilities](https://github.com/bowencool/async-utilities) ä»“åº“ä¸­ï¼Œå¹¶ä¸”å·²å‘å¸ƒåˆ° [npm](https://www.npmjs.com/package/@bowencool/async-utilities)

{/* prettier-ignore */}
{/* ç¬¬ä¸€ä½ç”·å­å«å¼‚æ­¥
èº«ç€è¥¿è£…èµ›å¾å…¬
ä»–æœ‰ä¸ªå¼Ÿå¼Ÿå«å›è°ƒ
ä½†å¼‚æ­¥åªçˆ±Promise

ç¬¬äºŒä½ç”·å­å«èŠ‚æµ
æ˜¯ä¸ªæµªæ¼«å°‘å¹´
å–œæ¬¢å»æ•‘åŠ©åŠ ç­çš„ç¨‹åºåª›ä½†æ›´å–œæ¬¢è·³èˆ

ç›´åˆ°æœ‰é‚£ä¹ˆä¸€å¤©
ä»–ä»¬å†³å®šå‡ºå»é—¯è¡ä¸–ç•Œ
ä»–ä»¬è¸ä¸Šäº†æ—…ç¨‹
æˆä¸ºäº†äººä»¬çš„å¶åƒ
å¶ç„¶æœ‰ä¸€å¤© \*/}

## èƒŒæ™¯

åœ¨`HTML`çš„è¡¨å•é‡Œï¼Œæœ‰è¿™æ ·ä¸€ç§åœºæ™¯ï¼š

```html
<form id="form">
  <!-- <label for="name">Nameï¼š</label>
  <input type="text" name="name" id="name"> -->
  <button type="submit">submit</button>
</form>
```

ç‚¹å‡»â€œæäº¤â€å°±å¾€æœåŠ¡ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ï¼š

```js
// ç½‘ç»œè¯·æ±‚
function api(data) {
  console.log("submiting", data);
  return fetch("https://httpbin.org/delay/1.5", {
    body: JSON.stringify(data),
    method: "POST",
    mode: "cors",
  });
}

const form = document.getElementById("form");
const handler = async function (e) {
  e.preventDefault();
  const rez = await someApi({
    msg: "some data to be sent",
  });
  console.log(rez);
};

form.addEventListener("submit", handler);
```

ä¸ºé˜²æ­¢ç”¨æˆ·é‡å¤æäº¤ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šç»´æŠ¤ä¸€ä¸ª`loading`çŠ¶æ€...ä½†æ˜¯å†™å¾—å¤šäº†ï¼Œéš¾å…æœ‰ä¸€ç§æœºæ¢°åŠ³åŠ¨çš„æ„Ÿè§‰ã€‚è€Œä¸”ï¼Œå½“ä¸€ä¸ªè¡¨å•å‡ºç°å¾ˆå¤šæŒ‰é’®æ—¶ï¼Œæˆ‘å²‚ä¸æ˜¯ç»´æŠ¤å¾ˆå¤š`loading`å˜é‡?

æˆ‘çœ‹ç€çœ¼ç›å¥½ç´¯ï¼Œè€Œä¸”æ¥å£å“åº”å¾ˆå¿«ï¼Œå·å·å°‘å†™ä¸€ä¸ª`loading`åº”è¯¥ä¸ä¼šè¢«å‘ç°å§ğŸŒšï¼Œå¯æ˜¯ä¸‡ä¸€æ¥å£è¦æ˜¯æŒ‚äº†...ç®—äº†ï¼Œæ¥ä¸åŠæƒ³è¿™äº›äº†

ä¸Šé¢çš„åœºæ™¯ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰ç»å†è¿‡å‘¢ï¼Ÿå®é™…ä¸Šï¼Œå¤§å¤šæ•°äº§å“çš„æŒ‰é’®éƒ½æ˜¯æ²¡æœ‰`loading`æ•ˆæœçš„ï¼Œå› ä¸ºæ•´ä¸ªä¸–ç•Œå°±æ˜¯ä¸€ä¸ªå¤§è‰å°ç­å­ğŸ˜‚ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªåˆæ ¼çš„å‰ç«¯ï¼Œæ¯ä¸ªäººéƒ½éœ€è¦å¯¹ç”¨æˆ·ä½“éªŒè´Ÿè´£ï¼

## [èƒ½ä¸èƒ½ç«™ç€å°±æŠŠé’±æŒ£å’¯ï¼Ÿ](https://baike.baidu.com/item/%E7%AB%99%E7%9D%80%E6%8C%A3%E9%92%B1/1059382)

æˆ‘ä»¬å…ˆæ¥æ¢³ç†ä¸€ä¸‹ï¼š

1. çŸ­æ—¶é—´å†…æ¯ä¸ªäº‹ä»¶éƒ½ä¼šäº§ç”Ÿä¸€ä¸ª `promise`ï¼Œæ ¸å¿ƒéœ€æ±‚æ˜¯é™é¢‘ã€‚å³â€œ`promise`ä¸‰åƒï¼Œæˆ‘åªå–ä¸€ä¸ªç»“æœâ€
2. `promise` çš„å“åº”æ—¶é—´æ˜¯ä¸ç¡®å®šçš„

### é™é¢‘

å…ˆå›æƒ³ä¸€ä¸‹åŒæ­¥ä»£ç ä¸­äº‹ä»¶é™é¢‘ï¼šèŠ‚æµ(`throttle`)ã€é˜²æŠ–(`debounce`)ã€‚å…³äºè¿™ä¸¤è€…ï¼Œç›¸ä¿¡ä½ å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬ä¸€å¥è¯æ¦‚æ‹¬ï¼š

> äºŒè€…éƒ½æ˜¯**åœ¨å•ä½æ—¶é—´å†…çš„å¤šæ¬¡ç›¸åŒäº‹ä»¶ä¸­å–ä¸€æ¬¡è°ƒç”¨ï¼ˆä¹Ÿå¯ä»¥è¯´æˆï¼šäº‹ä»¶ä¸‰åƒï¼Œæˆ‘åªå–ä¸€æ¬¡æ‰§è¡Œï¼‰**ï¼Œä¸åŒçš„æ˜¯**å‰è€…å–çš„ç¬¬ä¸€æ¬¡ï¼Œåè€…å–çš„æœ€åä¸€æ¬¡**ã€‚

æŠŠæˆ‘ä»¬çš„éœ€æ±‚ä¹Ÿæ”¹æˆè¿™ç§å¥å¼ï¼šåœ¨**çŸ­æ—¶é—´å†…**çš„å¤šæ¬¡ç›¸åŒäº‹ä»¶ä¸­å–ä¸€æ¬¡è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªâ€œ**çŸ­æ—¶é—´å†…**â€æ‰æ˜¯å…³é”® !

### é‡æ–°å®šä¹‰é—´éš”

æˆ‘ä»¬å¸Œæœ›**ä¸Šä¸€ä¸ª`promise`ç»“æŸä¹‹å‰ï¼Œæ¥ä¸‹æ¥çš„`promise`åˆ›å»ºæ“ä½œç»Ÿç»Ÿä¸¢å¼ƒ**ã€‚æ‰€ä»¥ï¼Œâ€œçŸ­æ—¶é—´å†…â€å°±ç­‰äºâ€œä¸Šä¸€ä¸ª`promise`çš„`pending`æœŸé—´â€ï¼Œâ€œæ¥ä¸‹æ¥çš„`promise`åˆ›å»ºæ“ä½œç»Ÿç»Ÿä¸¢å¼ƒâ€æ„æ€å°±æ˜¯â€œå–ç¬¬ä¸€æ¬¡â€ï¼Œ`promise`çš„ä¸¢å¼ƒå¯ä»¥é€šè¿‡åˆ›å»ºâ€œæ°¸è¿œ`pending`â€çš„`promise`å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„éœ€æ±‚å°±æ˜¯ï¼š
**åœ¨ä¸Šä¸€ä¸ª`promise`çš„`pending`æœŸé—´ï¼Œå¤šæ¬¡`promise`åˆ›å»ºæ“ä½œä¸­å–ç¬¬ä¸€æ¬¡(å°±æ˜¯è¿™ä¸ªæ­£åœ¨`pending`çš„`promise`)æ‰§è¡Œã€‚**

### ç¼–ç 

æ€è·¯éƒ½å‚è€ƒäº†ï¼Œä»£ç ä¹Ÿå‚è€ƒä¸€ä¸‹å§ï¼Œè¿™é‡Œè´´ä¸ªç®€æ˜“ç‰ˆçš„èŠ‚æµå®ç°ä»£ç ï¼š

```js
/**
 * @description èŠ‚æµ
 * @param {function} fn
 * @param {number} ms æ¯«ç§’
 * @returns {function} èŠ‚æµåçš„function
 */
function throttle(fn, ms = 300) {
  let lastInvoke = 0;
  return function throttled(...args) {
    const now = Date.now();
    if (now - lastInvoke < ms) return;
    lastInvoke = now;
    fn.call(this, ...args);
  };
}
```

ä¾è‘«èŠ¦ç”»ç“¢ï¼Œç®€å•æ”¹é€ ä¸€ä¸‹ï¼š

```js
/**
 * @description å¼‚æ­¥èŠ‚æµï¼šä¸Šä¸€æ¬¡çš„promise pendingæœŸé—´ï¼Œä¸ä¼šå†æ¬¡è§¦å‘
 * @param {() => Promise<any>} fn
 * @returns {() => Promise<any>} èŠ‚æµåçš„function
 */
function throttleAsyncResult(fn) {
  let isPending = false;
  return function (...args) {
    if (isPending) return new Promise(() => {});
    isPending = true;
    return fn
      .call(this, ...args)
      .then((...args1) => {
        isPending = false;
        return Promise.resolve(...args1);
      })
      .catch((...args2) => {
        isPending = false;
        return Promise.reject(...args2);
      });
  };
}
```

### ä½¿ç”¨æ–¹æ³•([Demo](https://bowencool.github.io/async-utilities/functions/throttleAsyncResult/readme.html))

> ä»¥ä¸‹ Demo ä»¥ç½‘ç»œè¯·æ±‚ä¸ºä¾‹ï¼Œæ‰“å¼€ Devtool æŸ¥çœ‹æ•ˆæœã€‚

<ThrottleAsyncResultDemo client:load />

<br />

<details>
  <summary>æŸ¥çœ‹ä»£ç </summary>

```tsx
import { throttleAsyncResult } from "@bowencool/async-utilities";
/* make a network request */
function api(data: { msg: string }) {
  console.log("submiting", data);
  return fetch("https://httpbin.org/delay/1.5", {
    body: JSON.stringify(data),
    method: "POST",
    mode: "cors",
  });
}

const throttledApi = throttleAsyncResult(api);

export default function ThrottleAsyncResultDemo() {
  return (
    <button
      onClick={async function () {
        const rez = await throttledApi({
          msg: "some data to be sent",
        });
        console.log("completed");
      }}
    >
      submit(click me quickly)
    </button>
  );
}
```

</details>

æ‰“å¼€å¼€å‘è€…å·¥å…·å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºç‚¹å‡»å¤šå¿«ï¼Œå§‹ç»ˆä¸ä¼šå‡ºç°è¯·æ±‚å¹¶è¡Œçš„æƒ…å†µï¼š
![image](https://user-images.githubusercontent.com/20217146/73516882-d45bde00-4434-11ea-9cd4-0131730af133.png)
å¤§åŠŸå‘Šæˆï¼

## ä¸€ä¸ªå­ªç”Ÿå…„å¼Ÿ

### debounceAsyncResult

åˆšæ‰çš„`throttleAsyncResult`æ˜¯æ§åˆ¶å¦‚ä½•åˆ›å»º`promise`ï¼Œé‚£ä¹ˆå¦‚æœå·²ç»åˆ›å»ºäº†å¾ˆå¤š`promise`ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•æ‰èƒ½å–åˆ°æœ€æ–°çš„ç»“æœå‘¢ï¼Œæ¯•ç«Ÿå“ªä¸ª`promise`è·‘å¾—å¿«ï¼Œè°ä¹Ÿä¸çŸ¥é“ã€‚

æ‰€ä»¥å°±ä¼šæœ‰`debounceAsyncResult`([Demo](https://bowencool.github.io/async-utilities/functions/debounceAsyncResult/readme.html))ï¼š**å·²ç»åˆ›å»ºçš„ä¼—å¤š`promise`ä¸­ï¼Œå–æœ€ååˆ›å»ºçš„`promise`ç»“æœã€‚**

â€œå·æ‡’â€æ˜¯ç¨‹åºå‘˜ç¬¬ä¸€ç”Ÿäº§åŠ›ï¼Œå­¦åˆ°äº†å—ğŸ¤”?
