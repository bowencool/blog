---
pubDatetime: 2020-01-16T10:14:43Z
modDatetime: 2023-04-10T10:07:02Z
title: å½“èŠ‚æµé‡åˆ°å¼‚æ­¥
permalink: when-throttling-meets-asynchrony
originalUrl: https://api.github.com/repos/bowencool/blog/issues/3
tags:
  - frontend
  - javascript
  - async
description: å½“èŠ‚æµé‡åˆ°å¼‚æ­¥
---

2021.05.31 æ›´æ–°ï¼š
æ‰€æœ‰ä»£ç å·²ç»åŒ…å«åˆ° https://github.com/bowencool/async-utilities ä»“åº“ä¸­ï¼Œå¹¶ä¸”å·²å‘å¸ƒåˆ° npm

---

<!--
ç¬¬ä¸€ä½ç”·å­å«å¼‚æ­¥
èº«ç€è¥¿è£…èµ›å¾å…¬
ä»–æœ‰ä¸ªå¼Ÿå¼Ÿå«å›è°ƒ
ä½†å¼‚æ­¥åªçˆ±Promise

ç¬¬äºŒä½ç”·å­å«èŠ‚æµ
æ˜¯ä¸ªæµªæ¼«å°‘å¹´
å–œæ¬¢å»æ•‘åŠ©åŠ ç­çš„ç¨‹åºåª›ä½†æ›´å–œæ¬¢è·³èˆ

ç›´åˆ°æœ‰é‚£ä¹ˆä¸€å¤©
ä»–ä»¬å†³å®šå‡ºå»é—¯è¡ä¸–ç•Œ
ä»–ä»¬è¸ä¸Šäº†æ—…ç¨‹
æˆä¸ºäº†äººä»¬çš„å¶åƒ
å¶ç„¶æœ‰ä¸€å¤©
-->

åœ¨HTMLçš„è¡¨å•é‡Œ
æœ‰è¿™æ ·ä¸€ç§åœºæ™¯ï¼š

```html
<form id="form">
  <!-- <label for="name">Nameï¼š</label>
  <input type="text" name="name" id="name"> -->
  <button type="submit">submit</button>
</form>
```

ç‚¹å‡»â€œæäº¤â€å°±å¾€æœåŠ¡ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ï¼š

```js
// ç½‘ç»œè¯·æ±‚
function api(data) {
  console.log("submiting", data);
  return fetch("https://httpbin.org/delay/1.5", {
    body: JSON.stringify(data),
    method: "POST",
    mode: "cors",
  });
}

const form = document.getElementById("form");
const handler = async function (e) {
  e.preventDefault();
  const rez = await someApi({
    msg: "some data to be sent",
  });
  console.log(rez);
};

form.addEventListener("submit", handler);
```

ä¸ºé˜²æ­¢ç”¨æˆ·é‡å¤æäº¤ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šç»´æŠ¤ä¸€ä¸ª`loading`çŠ¶æ€...ä½†æ˜¯å†™å¾—å¤šäº†ï¼Œéš¾å…æœ‰ä¸€ç§æœºæ¢°åŠ³åŠ¨çš„æ„Ÿè§‰ã€‚è€Œä¸”ï¼Œå½“ä¸€ä¸ªè¡¨å•å‡ºç°å¾ˆå¤šæŒ‰é’®æ—¶ï¼Œæˆ‘å²‚ä¸æ˜¯ç»´æŠ¤å¾ˆå¤š`loading`å˜é‡? æˆ‘çœ‹ç€çœ¼ç›å¥½ç´¯ï¼Œè€Œä¸”æ¥å£å“åº”å¾ˆå¿«ï¼Œå·å·å°‘å†™ä¸€ä¸ª`loading`åº”è¯¥ä¸ä¼šè¢«å‘ç°å§ğŸŒšï¼Œå¯æ˜¯ä¸‡ä¸€æ¥å£è¦æ˜¯æŒ‚äº†...ç®—äº†ï¼Œæ¥ä¸åŠæƒ³è¿™äº›äº†

ä¸Šé¢çš„åœºæ™¯ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰ç»å†è¿‡å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬å°±æ¥æ¢ç©¶ä¸€ä¸‹ï¼š

# èƒ½ä¸èƒ½ç«™ç€å°±æŠŠé’±æŒ£å’¯ï¼Ÿ

æˆ‘ä»¬å…ˆæ¥æ¢³ç†ä¸€ä¸‹ï¼š

1. çŸ­æ—¶é—´å†…æ¯ä¸ªäº‹ä»¶éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªpromiseï¼Œæ ¸å¿ƒéœ€æ±‚æ˜¯é™é¢‘ã€‚å³â€œpromiseä¸‰åƒï¼Œæˆ‘åªå–ä¸€ä¸ªç»“æœâ€
2. promiseçš„å“åº”æ—¶é—´æ˜¯ä¸ç¡®å®šçš„

ç¬¬ä¸€ç‚¹ï¼Œé™é¢‘ï¼Œå…ˆå›æƒ³ä¸€ä¸‹åŒæ­¥ä»£ç ä¸­äº‹ä»¶é™é¢‘ï¼šèŠ‚æµ(throttle)ã€é˜²æŠ–(debounce)ã€‚å…³äºè¿™ä¸¤è€…ï¼Œç›¸ä¿¡ä½ å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬ä¸€å¥è¯æ¦‚æ‹¬ï¼š

> äºŒè€…éƒ½æ˜¯**åœ¨å•ä½æ—¶é—´å†…çš„å¤šæ¬¡ç›¸åŒäº‹ä»¶ä¸­å–ä¸€æ¬¡è°ƒç”¨ï¼ˆä¹Ÿå¯ä»¥è¯´æˆï¼šäº‹ä»¶ä¸‰åƒï¼Œæˆ‘åªå–ä¸€æ¬¡æ‰§è¡Œï¼‰**ï¼Œä¸åŒçš„æ˜¯**å‰è€…å–çš„ç¬¬ä¸€æ¬¡ï¼Œåè€…å–çš„æœ€åä¸€æ¬¡**ã€‚

æŠŠæˆ‘ä»¬çš„éœ€æ±‚ä¹Ÿæ”¹æˆè¿™ç§å¥å¼ï¼šåœ¨**çŸ­æ—¶é—´å†…**çš„å¤šæ¬¡ç›¸åŒäº‹ä»¶ä¸­å–ä¸€æ¬¡è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªâ€œ**çŸ­æ—¶é—´å†…**â€æ‰æ˜¯å…³é”® !

ç¬¬äºŒç‚¹ï¼Œpromiseçš„å“åº”æ—¶é—´æ˜¯ä¸ç¡®å®šçš„ï¼Œæˆ‘ä»¬å¸Œæœ›**ä¸Šä¸€ä¸ªpromiseç»“æŸä¹‹å‰ï¼Œæ¥ä¸‹æ¥çš„promiseåˆ›å»ºæ“ä½œç»Ÿç»Ÿä¸¢å¼ƒ**ã€‚æ‰€ä»¥ï¼Œâ€œçŸ­æ—¶é—´å†…â€å°±ç­‰äºâ€œä¸Šä¸€ä¸ªpromiseçš„pendingæœŸé—´â€ï¼Œâ€œæ¥ä¸‹æ¥çš„promiseåˆ›å»ºæ“ä½œç»Ÿç»Ÿä¸¢å¼ƒâ€æ„æ€å°±æ˜¯â€œå–ç¬¬ä¸€æ¬¡â€ï¼Œpromiseçš„ä¸¢å¼ƒå¯ä»¥åˆ›å»ºâ€œæ°¸è¿œpendingâ€çš„promiseï¼Œæ‰€ä»¥æˆ‘ä»¬çš„éœ€æ±‚å°±æ˜¯ï¼š
**åœ¨ä¸Šä¸€ä¸ªpromiseçš„pendingæœŸé—´ï¼Œå¤šæ¬¡promiseåˆ›å»ºæ“ä½œä¸­å–ç¬¬ä¸€æ¬¡(å°±æ˜¯è¿™ä¸ªæ­£åœ¨pendingçš„promise)æ‰§è¡Œã€‚**

æ€è·¯éƒ½å‚è€ƒäº†ï¼Œä»£ç ä¹Ÿå‚è€ƒä¸€ä¸‹å§ï¼Œè¿™é‡Œè´´ä¸ªç®€æ˜“ç‰ˆçš„èŠ‚æµï¼š

```js
/**
 * @description èŠ‚æµ
 * @param {function} fn
 * @param {number} ms æ¯«ç§’
 * @returns {function} èŠ‚æµåçš„function
 */
function throttle(fn, ms = 300) {
  let lastInvoke = 0;
  return function throttled(...args) {
    const now = Date.now();
    if (now - lastInvoke < ms) return;
    lastInvoke = now;
    fn.call(this, ...args);
  };
}
```

ä¾è‘«èŠ¦ç”»ç“¢ï¼š

```js
/**
 * @description å¼‚æ­¥èŠ‚æµï¼šä¸Šä¸€æ¬¡çš„promise pendingæœŸé—´ï¼Œä¸ä¼šå†æ¬¡è§¦å‘
 * @param {() => Promise<any>} fn
 * @returns {() => Promise<any>} èŠ‚æµåçš„function
 */
function throttleAsync(fn) {
  let isPending = false;
  return function (...args) {
    if (isPending) return new Promise(() => {});
    isPending = true;
    return fn
      .call(this, ...args)
      .then((...args1) => {
        isPending = false;
        return Promise.resolve(...args1);
      })
      .catch((...args2) => {
        isPending = false;
        return Promise.reject(...args2);
      });
  };
}
```

ä½¿ç”¨æ–¹æ³•([Demo](https://github.com/bowencool/async-utilities/blob/main/example/components/throttleAsync.vue))ï¼š

```js
// ç½‘ç»œè¯·æ±‚
function api(data) {
  console.log("submiting", data);
  return fetch("https://httpbin.org/delay/1.5", {
    body: JSON.stringify(data),
    method: "POST",
    mode: "cors",
  });
}
const throttledApi = throttleAsync(api);

// æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘
const button = document.getElementById("button");
const handler = async function () {
  const rez = await throttledApi({
    msg: "some data to be sent",
  });
  console.log("completed");
};

button.addEventListener("click", handler);
```

æ‰“å¼€å¼€å‘è€…å·¥å…·å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºç‚¹å‡»å¤šå¿«ï¼Œå§‹ç»ˆä¸ä¼šå‡ºç°è¯·æ±‚å¹¶è¡Œçš„æƒ…å†µï¼š
![image](https://user-images.githubusercontent.com/20217146/73516882-d45bde00-4434-11ea-9cd4-0131730af133.png)
å¤§åŠŸå‘Šæˆï¼

## debounceAsync

åˆšæ‰é‚£ä¸ªæ˜¯åˆ›å»ºpromiseå‰ï¼Œé‚£ä¹ˆå·²ç»åˆ›å»ºäº†å¾ˆå¤špromiseï¼Œåˆ°åº•æ€ä¹ˆæ‰èƒ½å–åˆ°æœ€æ–°çš„ç»“æœå‘¢ï¼Œæ¯•ç«Ÿå“ªä¸ªpromiseè·‘å¾—å¿«ï¼Œè°ä¹Ÿä¸çŸ¥é“ã€‚æ‰€ä»¥å°±ä¼šæœ‰`debounceAsync`([Demo](https://bowencool.github.io/async-utilities/))ï¼š
**å·²ç»åˆ›å»ºçš„ä¼—å¤špromiseä¸­ï¼Œå–æœ€ååˆ›å»ºçš„promiseç»“æœã€‚**

```js
/**
 * @description å¼‚æ­¥å»æŠ–ï¼šçŸ­æ—¶é—´å†…è§¦å‘å¤šæ¬¡ï¼Œå–æœ€åä¸€æ¬¡è§¦å‘çš„ç»“æœã€‚å¦‚æœè¯´debounceæ˜¯å‘é€å‰å–æœ€åä¸€æ¬¡è¾“å…¥ï¼Œé‚£ä¹ˆdebounceAsyncå°±æ˜¯å‘é€åå–æœ€åä¸€æ¬¡è¯·æ±‚å¯¹åº”çš„è¾“å‡ºã€‚
 * @example https://bowencool.github.io/async-utilities/
 * @param {() => Promise<any>} fn
 * @returns {() => Promise<any>} å»æŠ–åçš„function
 */
function debounceAsync(fn) {
  let lastFetchId = 0;

  return function (...args) {
    const fetchId = ++lastFetchId;

    return fn
      .call(this, ...args)
      .then((...a1) => {
        if (fetchId !== lastFetchId) {
          return new Promise(() => {});
        } else {
          return Promise.resolve(...a1);
        }
      })
      .catch((...a2) => {
        return Promise.reject(...a2);
      });
  };
}
```

â€œå·æ‡’â€æ˜¯ç¨‹åºå‘˜ç¬¬ä¸€ç”Ÿäº§åŠ›ï¼Œå­¦åˆ°äº†å—ğŸ¤”?
